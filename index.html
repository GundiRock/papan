<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Papan</title>
    <script src="node_modules/deep-diff/releases/deep-diff-0.3.4.min.js"></script>
    <link rel="import" href="template/mainwindow.html">

    <script>
      'use strict'

      function isElectron() {
        let p = typeof(process) !== "undefined" && process
        return !!p && !!p.versions && !!p.versions.electron
      }

      let startGame
      let toggleDebug

      if (isElectron()) {
        const electron = require('electron')
        const ipc = electron.ipcRenderer
        startGame = () => {
          ipc.once('asynchronous-reply', (event, game) => {
            const renderer = game.gamePath + '/' + game.gameData.webcomponent
            let link = document.createElement('link')
            link.setAttribute('rel', 'import')
            link.setAttribute('href', renderer)
            link.onload = () => {
              let view = document.createElement('papan-main-board')
              view.setAttribute('id', 'main-board')
              view.addEventListener('view-ready', () => {
                ipc.send('asynchronous-message', { type: 'refreshPublicScene' })
              })
              view.addEventListener('action', (event) => {
                ipc.send('asynchronous-message', { type: 'action', data: event.detail })
              })
              document.getElementById('main-view').appendChild(view)
            }
            document.body.appendChild(link)
          })
          ipc.send('asynchronous-message', { type: 'startGame' })
        }
        toggleDebug = () => {
          let gameData = electron.remote.getCurrentWindow().toggleDevTools()
        }
        ipc.on('publicSceneDelta', (event, { diff }) => {
          document.getElementById('main-board').applyPublicDelta(diff)
        })
      } else {
        startGame = () => {
          alert("Browser support not implemented yet")
        }
      }

      function closeMenuViews(){
        let views = document.getElementsByClassName("user-page")
        for (var i = 0; i < views.length; i++)
          views[i].style.display = 'none'
      }
  </script>

  <style is="papan-style">
    html:not([style-scope]):not(.style-scope),body:not([style-scope]):not(.style-scope) {
      margin: 0;
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
        background: #f1f1f1;
    }
  </style>

  </head>
  <body>
    <papan-main-window></papan-main-window>
  </body>

  <script>
    'use strict'

    if (isElectron()) {
      require('./renderer.js')
      require('devtron').install()
    } else {
      document.getElementById('github-link').style.display = 'inline'
    }
  </script>
</html>
