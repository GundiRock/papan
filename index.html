<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Papan</title>

    <link rel="stylesheet" href="index.css">

    <script src="node_modules/deep-diff/releases/deep-diff-0.3.4.min.js"></script>

    <link rel="import" href="bower_components/iron-icons/iron-icons.html">
    <link rel="import" href="bower_components/iron-icons/communication-icons.html">
    <link rel="import" href="bower_components/iron-icons/device-icons.html">
    <link rel="import" href="bower_components/iron-icons/places-icons.html">
    <link rel="import" href="bower_components/iron-selector/iron-selectable.html">
    <link rel="import" href="bower_components/iron-pages/iron-pages.html">
    <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="bower_components/paper-menu/paper-menu.html">
    <link rel="import" href="bower_components/paper-item/paper-item.html">
    <link rel="import" href="bower_components/paper-item/paper-icon-item.html">
    <link rel="import" href="bower_components/paper-button/paper-button.html">
    <link rel="import" href="bower_components/paper-card/paper-card.html">
    <link rel="import" href="bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
    <link rel="import" href="bower_components/app-layout/app-drawer/app-drawer.html">
    <link rel="import" href="bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
    <link rel="import" href="bower_components/app-layout/app-header/app-header.html">
    <link rel="import" href="bower_components/app-layout/app-header-layout/app-header-layout.html">
    <link rel="import" href="bower_components/app-layout/app-toolbar/app-toolbar.html">

    <link rel="import" href="template/profile.html">
    <link rel="import" href="template/game.html">

    <script>
      'use strict'

      function isElectron() {
        let p = typeof(process) !== "undefined" && process
        return !!p && !!p.versions && !!p.versions.electron
      }

      let startGame
      let toggleDebug

      if (isElectron()) {
        const electron = require('electron')
        const ipc = electron.ipcRenderer
        startGame = () => {
          ipc.once('asynchronous-reply', (event, game) => {
            const renderer = game.gamePath + '/' + game.gameData.webcomponent
            let link = document.createElement('link')
            link.setAttribute('rel', 'import')
            link.setAttribute('href', renderer)
            link.onload = () => {
              let view = document.createElement('papan-main-board')
              view.setAttribute('id', 'main-board')
              view.addEventListener('view-ready', () => {
                ipc.send('asynchronous-message', { type: 'refreshPublicScene' })
              })
              view.addEventListener('action', (event) => {
                ipc.send('asynchronous-message', { type: 'action', data: event.detail })
              })
              document.getElementById('main-view').appendChild(view)
            }
            document.body.appendChild(link)
          })
          ipc.send('asynchronous-message', { type: 'startGame' })
        }
        toggleDebug = () => {
          let gameData = electron.remote.getCurrentWindow().toggleDevTools()
        }
        ipc.on('publicSceneDelta', (event, { diff }) => {
          document.getElementById('main-board').applyPublicDelta(diff)
        })
      } else {
        startGame = () => {
          alert("Browser support not implemented yet")
        }
      }

      function closeMenuViews(){
        let views = document.getElementsByClassName("user-page")
        for (var i = 0; i < views.length; i++)
          views[i].style.display = 'none'
      }
  </script>

  </head>
  <body>
    <app-header reveals>
      <app-toolbar>
        <paper-icon-button icon="menu" onclick="drawer.toggle()"></paper-icon-button>
        <div main-title>Papan</div>
        <paper-icon-button icon="bug-report" onclick="toggleDebug()"></paper-icon-button>
        <a href="https://github.com/grumpycoders.papan" style="display: none;" id="github-link">
          <paper-icon-button icon="link"></paper-icon-button>
        </a>
      </app-toolbar>
    </app-header>
    <app-drawer id="drawer" swipe-open>
        <iron-selector fallback-selection="profile">
          <paper-icon-item class="appmenuitem" name="profile" onclick="showProfile()">
            <iron-icon icon="account-circle"></iron-icon>Profile
          </paper-icon-item>
          <paper-icon-item class="appmenuitem" name="friends">
            <iron-icon icon="communication:contacts"></iron-icon>Friends
          </paper-icon-item>
          <paper-icon-item class="appmenuitem" name="games">
            <iron-icon icon="places:casino"></iron-icon>Games
          </paper-icon-item>
          <paper-icon-item class="appmenuitem" name="servers">
            <iron-icon icon="device:dvr"></iron-icon>Servers
          </paper-icon-item>
      </iron-selector>
    </app-drawer>

    <iron-pages id="content" selected="test" attr-for-selected="name">
      <paper-button name="test" onclick="startGame();">Start Game</paper-button>
      <section name="profile"><papan-user-profile id="profile-view" username="Grumpy Coder"></papan-user-profile></section>
      <section name="game"><papan-game-page></papan-game-page></section>

    </iron-pages>
    <div id="main-view"></div>
  </body>

  <script>
    'use strict'

    if (isElectron()) {
      require('./renderer.js')
      require('devtron').install()
    } else {
      document.getElementById('github-link').style.display = 'inline'
    }

    window.onload = () => { 
      var view = document.getElementById('profile-view')
      view.addEventListener('gameclicked', (event) => { showGame(event.detail) } )
    }

      function showProfile() {
        var pages = document.getElementById('content')
        pages.select('profile')
        document.getElementById('drawer').close()
      }

      function showGame(event){
        var pages = document.getElementById('content')
        pages.select('game')
        document.getElementById('game-view').setAttribute('name', event.name)
        document.getElementById('drawer').close()
      }

       function gotoNext (event) {
        var pages = document.getElementById('content');
        pages.selectNext();
      }
      
  </script>
</html>
