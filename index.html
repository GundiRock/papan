<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Papan</title>

    <link rel="stylesheet" href="node_modules/material-design-icons/iconfont/material-icons.css">
    <link rel="stylesheet" href="node_modules/material-design-lite/dist/material.deep_purple-amber.min.css">

    <script src="node_modules/deep-diff/releases/deep-diff-0.3.4.min.js"></script>

    <script src="node_modules/document-register-element/build/document-register-element.max.js"></script>
    <link rel="import" href="node_modules/@polymer/polymer/polymer.html">
    <link rel="import" href="src/games/tic_tac_toe/render/tic_tac_toe.html">
    <link rel="import" href="template/profile.html">

    <script>
      'use strict'

      function isElectron() {
        let p = typeof(process) !== "undefined" && process
        return !!p && !!p.versions && !!p.versions.electron
      }

      let startGame
      let toggleDebug

      if (isElectron()) {
        const electron = require('electron')
        const ipc = electron.ipcRenderer
        startGame = () => {
          ipc.once('asynchronous-reply', (event, game) => {
            const renderer = game.gamePath + '/' + game.gameData.webcomponent
            let link = document.createElement('link')
            link.setAttribute('rel', 'import')
            link.setAttribute('href', renderer)
            link.onload = () => {
              let view = document.createElement('papan-main-board')
              view.setAttribute('id', 'main-board')
              view.addEventListener('view-ready', () => {
                ipc.send('asynchronous-message', { type: 'refreshPublicScene' })
              })
              view.addEventListener('action', (event) => {
                ipc.send('asynchronous-message', { type: 'action', data: event.detail })
              })
              document.getElementById('main-view').appendChild(view)
            }
            document.body.appendChild(link)
          })
          ipc.send('asynchronous-message', { type: 'startGame' })
        }
        toggleDebug = () => {
          let gameData = electron.remote.getCurrentWindow().toggleDevTools()
        }
        ipc.on('publicSceneDelta', (event, { diff }) => {
          document.getElementById('main-board').applyPublicDelta(diff)
        })
      } else {
        startGame = () => {
          alert("Browser support not implemented yet")
        }
      }

      document.body.addEventListener('click', function (event) {
        if (event.target.dataset.userpage) {
          handleUserMenu(event)
        }
      })

      function showProfile() {
        let view = document.getElementById('user-profile');
        var clone = document.importNode(view.content, true);
        document.getElementById('main-view').appendChild(clone);
      }
    </script>

  </head>
  <body>
    <mdl-layout>

      <mdl-drawer>
        <span class="mdl-layout-title">Menu</span>
        <mdl-navigation>
          <a onclick="showProfile()">
            <mdl-icon style="margin-right: 7px;" class="material-icons">account_circle</mdl-icon>Profile
          </a>
          <a>
            <mdl-icon style="margin-right: 7px;" class="material-icons">contacts</mdl-icon>Friends
	        </a>
          <a>
            <mdl-icon style="margin-right: 7px;" class="material-icons">casino</mdl-icon>Games
          </a>
          <a>
            <mdl-icon style="margin-right: 7px;" class="material-icons">dvr</mdl-icon>Servers
          </a>
        </mdl-navigation>
      </mdl-drawer>

      <mdl-header style="background-color: blue;">
        <mdl-header-row>
          <span class="mdl-layout-title" style="color: white;">Papan</span>
          <mdl-spacer></mdl-spacer>
          <mdl-navigation id="navigation">
            <a onclick="toggleDebug()">
              Debugger
            </a>
            <a href="https://github.com/grumpycoders.papan" style="display: none;" id="github-link">
              <mdl-icon style="margin-right: 7px;" class="material-icons">link</mdl-icon>Github
            </a>
          </mdl-navigation>
        </mdl-header-row>
      </mdl-header>

      <mdl-content>
        <mdl-button onclick="startGame();">
          Start Game
        </mdl-button>
        <div id="main-view">
           <papan-user-profile>toto
           </papan-user-profile>
        </div>
      </mdl-content>
    </mdl-layout>
  </body>

  <script src="node_modules/material-design-lite/dist/material.min.js"></script>
  <script src="node_modules/webcomponent-mdl/dist/webcomponent-mdl.min.js"></script>
  <script>
    'use strict'

    if (isElectron()) {
      require('./renderer.js')
      require('devtron').install()
    } else {
      document.getElementById('github-link').style.display = 'inline'
    }
  </script>
</html>
